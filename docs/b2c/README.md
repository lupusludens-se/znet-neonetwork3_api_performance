# Azure B2C User Identity

User Identity for NEO 3.0 will be managed and maintain in the Azure B2C tenet for customer facing identity for the Sustainability Business.  Azure B2C can be leveraged to implement specific user attribute definitions, provide specific claims, and customize user flows for registration and authentication / authorization.

## Registration Flow
---

![registration](../images/registrationarchitecture.png)

## Registration Sequence
---

![regseq](../images/regsequence.png)

## B2C Tenant Details.
---
### Non Production Client Application (Angular)

* __Tenant ID__: af2300c7-91af-4418-b50c-9b482630438b
* __Client ID__: be67923b-a8b2-4034-a184-cabbb7047a52

### Non Production API

* __Tenant ID__: af2300c7-91af-4418-b50c-9b482630438b
* __Client ID__: 5d1bf149-f06f-43a1-88d0-f23e58a3ffc6

### Production Client Application (Angular)

* __Tenant ID__: TBD
* __Client ID__: TBD

### Production API

* __Tenant ID__: TBD
* __Client ID__: TBD

#### Scopes / User Flows

## Custom User Flows
---

NEONetwork leverages a custom user flow for registration since an initial approval is required.  This is accomplished in the application and post approval a specific flow is followed to register the user in the identity provider.  The `code` for this customization can be found below.

[Custom User Flow Repository](https://bitbucket.org/schneider-electric/cloud-core-components/src/main/b2c/ief/neonetwork/)

Below is an example link that will start the user flow for the custom authorization flow for setting the password.

```
https://subnpb2c.b2clogin.com/subnpb2c.onmicrosoft.com/oauth2/v2.0/authorize?p=B2C_1A_NEOAUTHSSPRSIGNIN&client_id=<client_id>&nonce=defaultNonce&redirect_uri=<redirect_url>&scope=openid&response_type=code&prompt=login
```

## Graph API
---

The application interacts with Azure B2C through the `Graph API`.  This API is leveraged to create the initial identity in Azure B2C as well as set an extension attribute to notify B2C that during the initial attempt to register a custom flow and password reset is required.

### Client Credentials Flow

To interact with the Graph API you will need to get an access token.  For the Application Registration for Graph you created a credential that can be leveraged via the OAuth2 Client Credentials flow to produce the token.

```
POST https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token HTTP/1.1
Host: login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

client_id=<clientid>
&scope=https://graph.microsoft.com/.default
&client_secret=<clientsecret>
&grant_type=client_credentials
```

[Documentation](https://docs.microsoft.com/en-us/graph/auth-v2-service#4-get-an-access-token) 

### Create User API

Leveraging the Authorization token as the Bearer token in the request the following example shows how to create the initial identity in Azure B2C.

```
POST https://graph.microsoft.com/v1.0/users 

{
    "identities": [
        {
            "signInType": "emailAddress",
            "issuer": "subnpb2c.onmicrosoft.com",
            "issuerAssignedId": "kevinprice41@gmail.com"
        }
    ],
    "accountEnabled": true,
    "displayName": "Kevin Price",
    "givenName": "Kevin",
    "jobTitle": "Enterprise Architect",
    "mail": "kevinprice@....com",
    "mailNickname": "primary",
    "surname": "Price",
    "passwordProfile": {
        "forceChangePasswordNextSignIn": true,
        "password": "<initial password>"
    }
}
```

__NOTICE__: The initial password will be generated by the application.  This will never be sent to the user, but adds additional protection for the new identity in the system.


[DOCUMENTATION](https://docs.microsoft.com/en-us/graph/api/user-post-users?view=graph-rest-1.0&tabs=http)

### Update Extended Attribute

Azure B2C uses attribute extensions for customizations leveraged during user flows.  In this case an extension is created that tells the system the user must reset their password.

```
POST  https://graph.microsoft.com/v1.0/users/<userid>

{
    "extension_<appid>_mustResetPassword": true
}
```
__NOTICE__: The user id will be returned from the previous user creation request.  Extension attributes in the Microsoft Graph API are named by using the convention extension_ApplicationClientID_attributename, where the ApplicationClientID is equivalent to the appId but without the hyphens. For example, if the appId of the b2c-extensions-app application is 25883231-668a-43a7-80b2-5685c3f874bc and the attributename is loyaltyId, then the extension attribute will be named extension_25883231668a43a780b25685c3f874bc_loyaltyId.

[__POSTMAN COLLECTION__](NEONetworkB2CGraph.postman_collection)